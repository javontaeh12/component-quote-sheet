<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Component Quote Sheet</title>
<meta name="description" content="HVAC & Refrigeration Service Quote Form">
<meta property="og:title" content="Component Quote Sheet">
<meta property="og:description" content="HVAC & Refrigeration Service Quote Form">
<meta property="og:image" content="https://component-quote-sheet.vercel.app/og-image.png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://component-quote-sheet.vercel.app">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Quote Sheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1a3a5c;
    --primary-light: #2a5a8c;
    --accent: #c0392b;
    --bg: #eef1f5;
    --card: #ffffff;
    --border: #d0d5dd;
    --border-focus: #2a5a8c;
    --text: #1a1a2e;
    --text-muted: #667085;
    --input-bg: #f8f9fb;
    --section-bg: #f1f4f8;
    --success: #27ae60;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { overflow-x: hidden; max-width: 100vw; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg); padding: 0; color: var(--text);
    -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent;
  }
  .form-container { max-width: 940px; margin: 0 auto; background: var(--card); min-height: 100vh; }
  .form-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: #fff; padding: 20px; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  }
  .form-header h1 { font-size: 18px; font-weight: 700; }
  .form-header .subtitle { font-size: 11px; opacity: 0.75; margin-top: 2px; }
  .header-badge {
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
    padding: 4px 8px; border-radius: 5px; font-size: 8px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
  }
  .form-body { padding: 16px; }
  .section { margin-bottom: 20px; }
  .section-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
    padding-bottom: 8px; border-bottom: 2px solid var(--primary);
  }
  .section-header .section-icon {
    width: 26px; height: 26px; background: var(--primary); color: #fff;
    border-radius: 6px; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; flex-shrink: 0;
  }
  .section-header h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--primary); }
  .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
  .field { display: flex; flex-direction: column; flex: 1; min-width: 100%; }
  .field.half { min-width: calc(50% - 5px); }
  .field.third { min-width: calc(33.33% - 7px); }
  .field label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; color: var(--text-muted); }
  .field label .hint { font-weight: 400; text-transform: none; letter-spacing: 0; color: #98a2b3; font-size: 10px; }
  .field input, .field select, .field textarea {
    padding: 12px 14px; border: 1.5px solid var(--border); border-radius: 8px;
    font-size: 16px; font-family: inherit; background: var(--input-bg); color: var(--text);
    transition: border-color 0.2s, box-shadow 0.2s; -webkit-appearance: none; appearance: none;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(42,90,140,0.12); background: #fff;
  }
  .field input::placeholder, .field textarea::placeholder { color: #b0b8c4; }
  .field textarea { resize: vertical; min-height: 70px; line-height: 1.5; }
  .field select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667085' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px;
  }
  .page-group { display: flex; align-items: center; gap: 8px; }
  .page-group input {
    width: 60px; text-align: center; padding: 12px 8px; border: 1.5px solid var(--border);
    border-radius: 8px; font-size: 16px; font-family: inherit; background: var(--input-bg);
    color: var(--text); -webkit-appearance: none;
  }
  .page-group input:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(42,90,140,0.12); background: #fff; }
  .page-group span { font-weight: 600; color: var(--text-muted); font-size: 14px; }
  .status-field { flex: 1; min-width: calc(50% - 5px); }
  .status-field label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; color: var(--text-muted); display: block; }
  .pill-group { display: flex; border-radius: 8px; overflow: hidden; border: 1.5px solid var(--border); }
  .pill-group input[type="radio"] { display: none; }
  .pill-group label.pill {
    flex: 1; text-align: center; padding: 12px 16px; font-size: 14px; font-weight: 600;
    cursor: pointer; background: var(--input-bg); color: var(--text-muted);
    transition: all 0.2s; margin: 0; border-right: 1px solid var(--border);
    -webkit-tap-highlight-color: transparent;
  }
  .pill-group label.pill:last-of-type { border-right: none; }
  .pill-group input[type="radio"]:checked + label.pill { background: var(--primary); color: #fff; }

  /* ── Mobile Parts: One at a time ── */
  .parts-carousel { margin-top: 8px; }
  .part-card {
    background: var(--input-bg); border: 1.5px solid var(--border); border-radius: 12px;
    padding: 16px; display: none;
  }
  .part-card.active { display: block; }
  .part-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .part-card-header-left { display: flex; align-items: center; gap: 8px; }
  .part-card-num {
    background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700;
  }
  .part-card-label { font-size: 13px; font-weight: 600; color: var(--text); }
  .part-card .remove-btn {
    background: #fef2f2; color: var(--accent); border: 1.5px solid #fecaca;
    font-size: 13px; padding: 6px 12px; cursor: pointer; border-radius: 6px;
    font-weight: 600; font-family: inherit; -webkit-tap-highlight-color: transparent;
  }
  .part-card-fields { display: flex; flex-direction: column; gap: 10px; }
  .part-card-fields .pf { display: flex; flex-direction: column; }
  .part-card-fields .pf label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px; }
  .part-card-fields .pf input {
    padding: 12px 14px; border: 1.5px solid var(--border); border-radius: 8px;
    font-size: 16px; font-family: inherit; background: #fff; color: var(--text);
    -webkit-appearance: none;
  }
  .part-card-fields .pf input:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(42,90,140,0.12); }
  .part-card-fields .pf input::placeholder { color: #c5cad2; }
  .part-nav { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
  .part-nav-btn {
    flex: 1; padding: 12px; border: 1.5px solid var(--border); border-radius: 8px;
    background: #fff; color: var(--primary); font-size: 14px; font-weight: 600;
    font-family: inherit; cursor: pointer; text-align: center; -webkit-tap-highlight-color: transparent;
  }
  .part-nav-btn:disabled { opacity: 0.35; }
  .part-nav-dots { display: flex; gap: 6px; justify-content: center; padding: 0 8px; flex-wrap: wrap; max-width: 50%; }
  .part-nav-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
  .part-nav-dot.active { background: var(--primary); }

  /* Desktop table (hidden on mobile) */
  .parts-wrapper { display: none; }
  .parts-table { width: 100%; border-collapse: collapse; }
  .parts-table thead th { background: var(--primary); color: #fff; padding: 10px 12px; font-size: 11px; font-weight: 600; text-align: left; text-transform: uppercase; }
  .parts-table td { padding: 3px 4px; }
  .parts-table tbody tr { border-bottom: 1px solid #eef0f3; }
  .parts-table input { width: 100%; padding: 8px 10px; border: 1.5px solid transparent; border-radius: 4px; font-size: 13px; font-family: inherit; background: transparent; color: var(--text); }
  .parts-table input:focus { outline: none; border-color: var(--border-focus); background: #fff; }
  .parts-table .row-num { width: 30px; text-align: center; color: var(--text-muted); font-size: 11px; font-weight: 600; }
  .parts-table .remove-btn { background: none; color: #d0d5dd; border: none; cursor: pointer; padding: 4px 8px; font-size: 16px; }

  .table-actions { margin-top: 12px; }
  .add-row-btn {
    padding: 14px 20px; background: var(--section-bg); color: var(--primary);
    border: 1.5px dashed var(--border); border-radius: 8px; cursor: pointer;
    font-size: 14px; font-weight: 600; font-family: inherit; width: 100%; text-align: center;
    -webkit-tap-highlight-color: transparent;
  }

  /* Action Buttons */
  .actions {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    margin-top: 24px; padding-top: 20px; border-top: 1.5px solid #eef0f3;
  }
  .actions button {
    padding: 14px 12px; font-size: 13px; font-weight: 600; font-family: inherit;
    border: none; border-radius: 10px; cursor: pointer; display: flex;
    align-items: center; justify-content: center; gap: 6px;
    -webkit-tap-highlight-color: transparent;
  }
  .actions button:active { opacity: 0.8; }
  .btn-download { background: var(--primary); color: #fff; }
  .btn-photo { background: #8e44ad; color: #fff; }
  .btn-print { background: var(--success); color: #fff; }
  .btn-reset { background: #fff; color: var(--text-muted); border: 1.5px solid var(--border) !important; }

  /* Scan Dataplate Buttons */
  .scan-buttons {
    display: flex; gap: 10px; margin-bottom: 16px;
  }
  .scan-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    flex: 1; padding: 12px 10px;
    background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
    color: #fff; border: none; border-radius: 10px;
    font-size: 13px; font-weight: 600; font-family: inherit;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
    box-shadow: 0 2px 8px rgba(230,126,34,0.3);
  }
  .scan-btn.gallery-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    box-shadow: 0 2px 8px rgba(52,152,219,0.3);
  }
  .scan-btn:active { opacity: 0.9; transform: scale(0.98); }
  .scan-btn svg { flex-shrink: 0; }

  /* Scanner Modal */
  .scanner-modal {
    display: none; position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.95); flex-direction: column;
  }
  .scanner-modal.active { display: flex; }
  .scanner-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; background: rgba(255,255,255,0.05);
  }
  .scanner-header h3 { color: #fff; font-size: 16px; font-weight: 600; }
  .scanner-close {
    background: rgba(255,255,255,0.1); border: none; color: #fff;
    width: 36px; height: 36px; border-radius: 50%; font-size: 20px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .scanner-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .scanner-preview {
    width: 100%; max-width: 400px; background: #1a1a1a;
    border-radius: 12px; overflow: hidden; position: relative;
    border: 2px solid rgba(255,255,255,0.1);
    min-height: 200px; display: flex; align-items: center; justify-content: center;
  }
  .scanner-preview img, .scanner-preview video {
    width: 100%; height: auto; object-fit: contain; max-height: 60vh;
  }
  .scanner-preview .scan-guide {
    display: none;
  }
  .scanner-status {
    margin-top: 20px; color: #fff; font-size: 14px; text-align: center;
    min-height: 24px;
  }
  .scanner-status.processing { color: #f39c12; }
  .scanner-status.success { color: #27ae60; }
  .scanner-status.error { color: #e74c3c; }
  .scanner-actions { display: flex; gap: 12px; margin-top: 20px; width: 100%; max-width: 400px; }
  .scanner-actions button {
    flex: 1; padding: 14px 16px; border-radius: 10px; font-size: 14px;
    font-weight: 600; font-family: inherit; cursor: pointer; border: none;
    -webkit-tap-highlight-color: transparent;
  }
  .scanner-actions .btn-capture { background: #27ae60; color: #fff; }
  .scanner-actions .btn-capture:disabled { background: #555; color: #999; }
  .scanner-actions .btn-retake { background: rgba(255,255,255,0.1); color: #fff; }
  .scanner-actions .btn-use { background: #3498db; color: #fff; }
  .scanner-actions .btn-use:disabled { background: #555; color: #999; }

  /* File input for camera */
  #cameraInput { display: none; }

  .form-footer { background: var(--section-bg); padding: 14px 16px; text-align: center; font-size: 10px; color: var(--text-muted); border-top: 1px solid #e4e7ec; }

  /* ── Print output (hidden offscreen until export) ── */
  #printOutput {
    position: absolute; left: -9999px; top: 0;
    width: 816px; /* letter width at 96dpi */
    font-family: 'Inter', sans-serif; color: #1a1a2e; background: #fff;
  }
  #printOutput .po-header {
    background: #1a3a5c; color: #fff; padding: 24px 32px;
    display: flex; justify-content: space-between; align-items: center;
  }
  #printOutput .po-header h1 { font-size: 22px; font-weight: 700; }
  #printOutput .po-header .po-badge {
    background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
    padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 1px;
  }
  #printOutput .po-body { padding: 24px 32px; }
  #printOutput .po-section { margin-bottom: 20px; }
  #printOutput .po-section-title {
    font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
    color: #1a3a5c; border-bottom: 2px solid #1a3a5c; padding-bottom: 6px; margin-bottom: 12px;
  }
  #printOutput .po-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px 24px;
  }
  #printOutput .po-grid.three { grid-template-columns: 1fr 1fr 1fr; }
  #printOutput .po-field { margin-bottom: 6px; }
  #printOutput .po-field .po-label {
    font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    color: #667085; margin-bottom: 2px;
  }
  #printOutput .po-field .po-value {
    font-size: 13px; font-weight: 500; color: #1a1a2e; padding: 4px 0;
    border-bottom: 1px solid #e4e7ec; min-height: 22px;
  }
  #printOutput .po-field.full { grid-column: 1 / -1; }
  #printOutput .po-field .po-value.multiline { white-space: pre-wrap; line-height: 1.5; }
  #printOutput .po-parts-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  #printOutput .po-parts-table th {
    background: #1a3a5c; color: #fff; padding: 8px 10px; font-size: 10px;
    font-weight: 600; text-transform: uppercase; text-align: left;
  }
  #printOutput .po-parts-table td {
    padding: 7px 10px; font-size: 12px; border-bottom: 1px solid #e4e7ec;
  }
  #printOutput .po-parts-table tr:nth-child(even) { background: #f8f9fb; }
  #printOutput .po-footer {
    text-align: center; padding: 12px; font-size: 9px; color: #98a2b3;
    border-top: 1px solid #e4e7ec;
  }

  /* ── Desktop overrides ── */
  @media (min-width: 768px) {
    body { padding: 30px 20px; }
    .form-container { border-radius: 12px; box-shadow: var(--shadow); min-height: auto; }
    .form-header { padding: 28px 40px; position: static; box-shadow: none; }
    .form-header h1 { font-size: 24px; }
    .header-badge { padding: 8px 16px; font-size: 12px; }
    .form-body { padding: 32px 40px 40px; }
    .field { min-width: 170px; }
    .field.half, .field.third { min-width: 170px; }
    .field input, .field select, .field textarea { font-size: 14px; padding: 9px 12px; }
    .page-group input { font-size: 14px; padding: 9px 6px; width: 52px; }
    .pill-group label.pill { padding: 9px 16px; font-size: 13px; }
    .status-field { min-width: 170px; }
    .parts-carousel { display: none; }
    .parts-wrapper { display: block; border: 1.5px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 8px; }
    .add-row-btn { width: auto; padding: 8px 20px; font-size: 13px; }
    .actions { display: flex; gap: 12px; justify-content: center; }
    .actions button { padding: 12px 32px; font-size: 14px; }
    .form-footer { padding: 16px 40px; font-size: 11px; }
  }
  @media print {
    body { background: #fff; padding: 0; }
    .form-container { display: none; }
    #printOutput { position: static !important; left: auto !important; display: block !important; }
  }
</style>
</head>
<body>

<div class="form-container" id="quoteForm">
  <div class="form-header">
    <div><h1>Component Quote Sheet</h1><div class="subtitle">HVAC / Refrigeration Service</div></div>
    <div class="header-badge">Service Quote</div>
  </div>
  <div class="form-body">

    <div class="section">
      <div class="section-header"><div class="section-icon">1</div><h2>Job Information</h2></div>
      <div class="row"><div class="field"><label>Customer Name</label><input type="text" id="customerName" placeholder="Enter customer name"></div></div>
      <div class="row">
        <div class="field half"><label>Store #</label><input type="text" id="storeNumber" placeholder="Store #"></div>
        <div class="field half"><label>WO Number</label><input type="text" id="woNumber" placeholder="Work order #"></div>
      </div>
      <div class="row">
        <div class="field half"><label>Tech</label><input type="text" id="tech" placeholder="Technician name"></div>
        <div class="field half"><label>Page</label><div class="page-group"><input type="text" id="pageNum" placeholder="#"><span>of</span><input type="text" id="pageOf" placeholder="#"></div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><div class="section-icon">2</div><h2>Equipment Details</h2></div>
      <div class="scan-buttons">
        <button class="scan-btn" onclick="openCamera()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Scan Dataplate
        </button>
        <button class="scan-btn gallery-btn" onclick="openGallery()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Upload Image
        </button>
      </div>
      <div class="row"><div class="field"><label>Equipment Type</label><input type="text" id="equipmentType" placeholder="e.g. RTU, Condenser, Walk-in Cooler"></div></div>
      <div class="row"><div class="field">
        <label>Location</label>
        <select id="location"><option value="">-- Select Location --</option><option value="Roof">Roof</option><option value="Ground">Ground</option><option value="Self-Contained">Self-Contained</option></select>
      </div></div>
      <div class="row"><div class="field">
        <label>Manufacturer <span class="hint">- type to search or enter custom</span></label>
        <input type="text" id="manufacturer" list="mfgList" placeholder="Select or type manufacturer" autocomplete="off">
        <datalist id="mfgList">
          <option value="AAON"><option value="ADP (Advanced Distributor Products)"><option value="Aire-Flo"><option value="Amana"><option value="American Standard">
          <option value="Armstrong Air"><option value="Bard Manufacturing"><option value="Bosch"><option value="Bryant"><option value="Carrier">
          <option value="Comfortmaker"><option value="Daikin"><option value="Dunham-Bush"><option value="Friedrich"><option value="Fujitsu">
          <option value="Goodman"><option value="Heil"><option value="Honeywell"><option value="ICP (International Comfort Products)"><option value="Johnson Controls">
          <option value="Lennox"><option value="LG"><option value="Luxaire"><option value="Mammoth"><option value="McQuay International">
          <option value="Mitsubishi Electric"><option value="Modine"><option value="Nortek"><option value="Payne"><option value="Reznor">
          <option value="Rheem"><option value="Ruud"><option value="Samsung"><option value="Trane"><option value="York">
          <option value="Bally Refrigerated Boxes"><option value="Beacon/Morris"><option value="Bohn (Heatcraft)"><option value="Bristol Compressors">
          <option value="Climate Master"><option value="Copeland (Emerson)"><option value="Danfoss"><option value="Embraco"><option value="Heatcraft">
          <option value="Hill Phoenix"><option value="Hussmann"><option value="KeepRite Refrigeration"><option value="Kelvinator Commercial">
          <option value="Kolpak"><option value="Kramer Trenton"><option value="Kysor/Warren"><option value="Larkin (Heatcraft)"><option value="Master-Bilt">
          <option value="McCall"><option value="Nor-Lake"><option value="Randell"><option value="Russell"><option value="Sporlan">
          <option value="Sub-Zero Commercial"><option value="Tecumseh"><option value="Traulsen"><option value="True Manufacturing"><option value="Turbo Air">
          <option value="Tyler Refrigeration"><option value="Victory Refrigeration"><option value="Walk-In Cooler Warehouse"><option value="Zero Zone">
        </datalist>
      </div></div>
      <div class="row"><div class="field"><label>Unit</label><input type="text" id="unit" placeholder="Unit ID"></div></div>
      <div class="row"><div class="field"><label>Model #</label><input type="text" id="modelNumber" placeholder="Model number"></div></div>
      <div class="row"><div class="field"><label>Serial #</label><input type="text" id="serialNumber" placeholder="Serial number"></div></div>
      <div class="row">
        <div class="field half"><label>Voltage</label><input type="text" id="voltage" placeholder="e.g. 208/230"></div>
        <div class="field half"><label>Phase</label><input type="text" id="phase" placeholder="e.g. 1, 3"></div>
      </div>
      <div class="row"><div class="field"><label>Refrigerant</label><input type="text" id="refrigerant" placeholder="e.g. R-410A, R-22"></div></div>
      <div class="row">
        <div class="status-field"><label>Warranty</label><div class="pill-group"><input type="radio" name="warranty" id="warrantyYes" value="Yes"><label class="pill" for="warrantyYes">Yes</label><input type="radio" name="warranty" id="warrantyNo" value="No"><label class="pill" for="warrantyNo">No</label></div></div>
        <div class="status-field"><label>Operational</label><div class="pill-group"><input type="radio" name="operational" id="operationalYes" value="Yes"><label class="pill" for="operationalYes">Yes</label><input type="radio" name="operational" id="operationalNo" value="No"><label class="pill" for="operationalNo">No</label></div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><div class="section-icon">3</div><h2>Service Details</h2></div>
      <div class="row"><div class="field"><label>Work Performed</label><textarea id="workPerformed" rows="3" placeholder="Describe work performed..."></textarea></div></div>
      <div class="row"><div class="field"><label>Reason for Repair</label><textarea id="reasonForRepair" rows="3" placeholder="Describe reason for repair..."></textarea></div></div>
      <div class="row"><div class="field"><label>Equipment Needed <span class="hint">- scissor lift, duct jack, 40' ladder, etc.</span></label><textarea id="equipmentNeeded" rows="2" placeholder="List any special equipment needed..."></textarea></div></div>
      <div class="row"><div class="field"><label>Other Comments</label><textarea id="otherComments" rows="2" placeholder="Additional notes or comments..."></textarea></div></div>
    </div>

    <div class="section">
      <div class="section-header"><div class="section-icon">4</div><h2>Logistics</h2></div>
      <div class="row">
        <div class="status-field"><label>Boom Truck Needed?</label><div class="pill-group"><input type="radio" name="boomTruck" id="boomYes" value="Yes"><label class="pill" for="boomYes">Yes</label><input type="radio" name="boomTruck" id="boomNo" value="No"><label class="pill" for="boomNo">No</label></div></div>
        <div class="status-field"><label>Trailer Needed?</label><div class="pill-group"><input type="radio" name="trailerNeeded" id="trailerYes" value="Yes"><label class="pill" for="trailerYes">Yes</label><input type="radio" name="trailerNeeded" id="trailerNo" value="No"><label class="pill" for="trailerNo">No</label></div></div>
      </div>
      <div class="row">
        <div class="field third"><label>Up</label><input type="text" id="boomUp" placeholder="ft"></div>
        <div class="field third"><label>In</label><input type="text" id="boomIn" placeholder="ft"></div>
        <div class="field third"><label>Set Back</label><input type="text" id="boomSetBack" placeholder="ft"></div>
      </div>
      <div class="row">
        <div class="field third"><label>Tech Hours</label><input type="text" id="techHours" placeholder="Hrs"></div>
        <div class="field third"><label>Helper</label><input type="text" id="helperHours" placeholder="Hrs"></div>
        <div class="field third"><label>Travel</label><input type="text" id="travelHours" placeholder="Hrs"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><div class="section-icon">5</div><h2>Parts & Materials</h2></div>
      <div class="parts-carousel" id="partsCarousel">
        <div class="parts-list" id="partsList"></div>
        <div class="part-nav" id="partNav" style="display:none;">
          <button class="part-nav-btn" id="partPrev" onclick="navigatePart(-1)">&larr; Prev</button>
          <div class="part-nav-dots" id="partDots"></div>
          <button class="part-nav-btn" id="partNext" onclick="navigatePart(1)">Next &rarr;</button>
        </div>
      </div>
      <div class="parts-wrapper">
        <table class="parts-table" id="partsTable"><thead><tr>
          <th style="width:30px;">#</th><th>Description</th><th style="width:140px;">Part #</th>
          <th style="width:80px;">Qty</th><th style="width:110px;">Cost</th><th style="width:130px;">Vendor</th><th style="width:36px;"></th>
        </tr></thead><tbody id="partsBody"></tbody></table>
      </div>
      <div class="table-actions">
        <button class="add-row-btn" type="button" onclick="addPartRow()">+ Add Part</button>
        <div id="partCount" style="text-align:center;margin-top:8px;font-size:12px;color:#667085;font-weight:500;"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-photo" onclick="saveAsPhoto()"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4.5A1.5 1.5 0 013.5 3h1.172a1.5 1.5 0 011.06.44L6.94 4.646A.5.5 0 007.293 4.5H12.5A1.5 1.5 0 0114 6v6.5a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 012 12.5v-8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="9" r="2.5" stroke="currentColor" stroke-width="1.5"/></svg> Photo</button>
      <button class="btn-reset" onclick="resetForm()"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2v4.5h4.5M14 14v-4.5H9.5M1.5 10a6.5 6.5 0 0111.48-3M14.5 6a6.5 6.5 0 01-11.48 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Reset</button>
    </div>
  </div>
  <div class="form-footer">All fields auto-save. Your data will be here when you come back.</div>
</div>

<!-- Hidden professional output for PDF/Photo/Print -->
<div id="printOutput"></div>

<!-- Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-header">
    <h3>Scan Dataplate</h3>
    <button class="scanner-close" onclick="closeScanner()">&times;</button>
  </div>
  <div class="scanner-body">
    <div class="scanner-preview" id="scannerPreview">
      <img id="capturedImage" style="display:none;">
      <div class="scan-guide"></div>
    </div>
    <div class="scanner-status" id="scannerStatus">Tap capture to take a photo of the dataplate</div>
    <div class="scanner-actions" id="scannerActions">
      <button class="btn-capture" id="btnCapture" onclick="capturePhoto()">Capture Photo</button>
    </div>
  </div>
</div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCameraCapture(event)">
<input type="file" id="galleryInput" accept="image/*" onchange="handleCameraCapture(event)">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const STORAGE_KEY = 'componentQuoteSheet';
let rowCount = 0, isRestoring = false, currentPartIndex = 0;

const fieldIds = [
  'customerName','storeNumber','woNumber','tech','pageNum','pageOf',
  'equipmentType','location','manufacturer','unit','modelNumber','serialNumber',
  'voltage','phase','refrigerant','workPerformed','reasonForRepair','equipmentNeeded',
  'otherComments','boomUp','boomIn','boomSetBack','techHours','helperHours','travelHours'
];
const radioNames = ['warranty','operational','boomTruck','trailerNeeded'];

function val(id) { const el = document.getElementById(id); return el ? el.value : ''; }
function radioVal(name) { const c = document.querySelector(`input[name="${name}"]:checked`); return c ? c.value : '—'; }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ── Build professional output HTML ──
function buildOutput() {
  const parts = [];
  document.querySelectorAll('#partsList .part-card').forEach(card => {
    const inputs = card.querySelectorAll('input');
    const r = { desc: inputs[0]?.value||'', part: inputs[1]?.value||'', qty: inputs[2]?.value||'', cost: inputs[3]?.value||'', vendor: inputs[4]?.value||'' };
    if (r.desc || r.part || r.qty || r.cost || r.vendor) parts.push(r);
  });

  const today = new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  const pageStr = val('pageNum') && val('pageOf') ? `Page ${esc(val('pageNum'))} of ${esc(val('pageOf'))}` : '';

  let partsHTML = '';
  if (parts.length > 0) {
    partsHTML = `<table class="po-parts-table"><thead><tr>
      <th>#</th><th>Description</th><th>Part #</th><th>Qty</th><th>Cost</th><th>Vendor</th>
    </tr></thead><tbody>`;
    parts.forEach((p, i) => {
      partsHTML += `<tr><td>${i+1}</td><td>${esc(p.desc)}</td><td>${esc(p.part)}</td><td>${esc(p.qty)}</td><td>${esc(p.cost)}</td><td>${esc(p.vendor)}</td></tr>`;
    });
    partsHTML += '</tbody></table>';
  } else {
    partsHTML = '<p style="color:#98a2b3;font-size:12px;font-style:italic;">No parts listed</p>';
  }

  return `
    <div class="po-header">
      <div><h1>Component Quote Sheet</h1><div style="font-size:11px;opacity:0.7;margin-top:3px;">HVAC / Refrigeration Service Documentation</div></div>
      <div style="text-align:right;"><div class="po-badge">Service Quote</div><div style="font-size:10px;opacity:0.7;margin-top:6px;">${today}</div></div>
    </div>
    <div class="po-body">
      <div class="po-section">
        <div class="po-section-title">Job Information</div>
        <div class="po-grid">
          <div class="po-field"><div class="po-label">Customer Name</div><div class="po-value">${esc(val('customerName'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Store #</div><div class="po-value">${esc(val('storeNumber'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">WO Number</div><div class="po-value">${esc(val('woNumber'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Technician</div><div class="po-value">${esc(val('tech'))||'—'}</div></div>
        </div>
        ${pageStr ? `<div style="text-align:right;font-size:11px;color:#667085;margin-top:4px;">${pageStr}</div>` : ''}
      </div>

      <div class="po-section">
        <div class="po-section-title">Equipment Details</div>
        <div class="po-grid">
          <div class="po-field"><div class="po-label">Equipment Type</div><div class="po-value">${esc(val('equipmentType'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Location</div><div class="po-value">${esc(val('location'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Manufacturer</div><div class="po-value">${esc(val('manufacturer'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Unit</div><div class="po-value">${esc(val('unit'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Model #</div><div class="po-value">${esc(val('modelNumber'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Serial #</div><div class="po-value">${esc(val('serialNumber'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Voltage</div><div class="po-value">${esc(val('voltage'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Phase</div><div class="po-value">${esc(val('phase'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Refrigerant</div><div class="po-value">${esc(val('refrigerant'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Warranty</div><div class="po-value">${radioVal('warranty')}</div></div>
          <div class="po-field"><div class="po-label">Operational</div><div class="po-value">${radioVal('operational')}</div></div>
        </div>
      </div>

      <div class="po-section">
        <div class="po-section-title">Service Details</div>
        <div class="po-grid">
          <div class="po-field full"><div class="po-label">Work Performed</div><div class="po-value multiline">${esc(val('workPerformed'))||'—'}</div></div>
          <div class="po-field full"><div class="po-label">Reason for Repair</div><div class="po-value multiline">${esc(val('reasonForRepair'))||'—'}</div></div>
          <div class="po-field full"><div class="po-label">Equipment Needed</div><div class="po-value multiline">${esc(val('equipmentNeeded'))||'—'}</div></div>
          <div class="po-field full"><div class="po-label">Other Comments</div><div class="po-value multiline">${esc(val('otherComments'))||'—'}</div></div>
        </div>
      </div>

      <div class="po-section">
        <div class="po-section-title">Logistics</div>
        <div class="po-grid three">
          <div class="po-field"><div class="po-label">Boom Truck</div><div class="po-value">${radioVal('boomTruck')}</div></div>
          <div class="po-field"><div class="po-label">Trailer Needed</div><div class="po-value">${radioVal('trailerNeeded')}</div></div>
          <div class="po-field"><div class="po-label">Up</div><div class="po-value">${esc(val('boomUp'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">In</div><div class="po-value">${esc(val('boomIn'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Set Back</div><div class="po-value">${esc(val('boomSetBack'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Tech Hours</div><div class="po-value">${esc(val('techHours'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Helper</div><div class="po-value">${esc(val('helperHours'))||'—'}</div></div>
          <div class="po-field"><div class="po-label">Travel</div><div class="po-value">${esc(val('travelHours'))||'—'}</div></div>
        </div>
      </div>

      <div class="po-section">
        <div class="po-section-title">Parts & Materials</div>
        ${partsHTML}
      </div>
    </div>
    <div class="po-footer">Component Quote Sheet &mdash; Generated ${today}</div>
  `;
}

// ── Export functions ──
function getFilename(ext) {
  const c = val('customerName') || 'Quote';
  const w = val('woNumber');
  return `Component_Quote_${c.replace(/\s+/g,'_')}${w ? '_WO'+w : ''}.${ext}`;
}

function triggerDownload(blob, filename, mimeType) {
  const url = URL.createObjectURL(blob);
  if (navigator.share && navigator.canShare) {
    try {
      const file = new File([blob], filename, { type: mimeType });
      if (navigator.canShare({ files: [file] })) {
        navigator.share({ files: [file], title: filename }).catch(() => window.open(url, '_blank'));
        return;
      }
    } catch(e) {}
  }
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

function downloadPDF() {
  const output = document.getElementById('printOutput');
  output.innerHTML = buildOutput();
  output.style.left = '0'; output.style.position = 'fixed'; output.style.top = '0'; output.style.zIndex = '9999';
  const filename = getFilename('pdf');
  html2pdf().set({
    margin: [0,0,0,0], filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
    jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
  }).from(output).outputPdf('blob').then(blob => {
    triggerDownload(blob, filename, 'application/pdf');
    output.style.left = '-9999px'; output.style.position = 'absolute'; output.style.zIndex = '';
  }).catch(() => { output.style.left = '-9999px'; output.style.position = 'absolute'; });
}

function saveAsPhoto() {
  const output = document.getElementById('printOutput');
  output.innerHTML = buildOutput();
  output.style.left = '0'; output.style.position = 'fixed'; output.style.top = '0'; output.style.zIndex = '9999';
  const filename = getFilename('png');
  setTimeout(() => {
    html2canvas(output, { scale: 2, useCORS: true, backgroundColor: '#ffffff', scrollY: 0 }).then(canvas => {
      canvas.toBlob(blob => {
        triggerDownload(blob, filename, 'image/png');
        output.style.left = '-9999px'; output.style.position = 'absolute'; output.style.zIndex = '';
      }, 'image/png');
    }).catch(() => { output.style.left = '-9999px'; output.style.position = 'absolute'; });
  }, 100);
}

function printQuote() {
  const output = document.getElementById('printOutput');
  output.innerHTML = buildOutput();
  window.print();
}

// ── Save / Restore ──
function saveForm() {
  if (isRestoring) return;
  const data = {};
  fieldIds.forEach(id => { data[id] = val(id); });
  radioNames.forEach(name => { const c = document.querySelector(`input[name="${name}"]:checked`); data['radio_'+name] = c ? c.value : ''; });
  const parts = [];
  document.querySelectorAll('#partsList .part-card').forEach(card => {
    const inputs = card.querySelectorAll('input');
    const row = []; inputs.forEach(inp => row.push(inp.value)); parts.push(row);
  });
  data.parts = parts;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function restoreForm() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) { addPartRow(); return; }
  isRestoring = true;
  const data = JSON.parse(raw);
  fieldIds.forEach(id => { const el = document.getElementById(id); if (el && data[id] !== undefined) el.value = data[id]; });
  radioNames.forEach(name => { const v = data['radio_'+name]; if (v) { const r = document.querySelector(`input[name="${name}"][value="${v}"]`); if (r) r.checked = true; } });
  if (data.parts && data.parts.length > 0) {
    data.parts.forEach(rowData => {
      addPartRow();
      const card = document.querySelector('#partsList .part-card:last-child');
      const ci = card.querySelectorAll('input');
      const tr = document.querySelector('#partsBody tr:last-child');
      const ti = tr.querySelectorAll('input');
      rowData.forEach((v,i) => { if(ci[i]) ci[i].value=v; if(ti[i]) ti[i].value=v; });
    });
  } else { addPartRow(); }
  isRestoring = false;
  updatePartView();
}

// ── Parts ──
function addPartRow() {
  rowCount++;
  const n = rowCount;
  const total = document.querySelectorAll('#partsList .part-card').length + 1;

  const list = document.getElementById('partsList');
  const card = document.createElement('div');
  card.className = 'part-card'; card.dataset.row = n;
  card.innerHTML = `
    <div class="part-card-header">
      <div class="part-card-header-left"><div class="part-card-num">${total}</div><span class="part-card-label">Part ${total}</span></div>
      <button class="remove-btn" onclick="removeRow(${n})">Remove</button>
    </div>
    <div class="part-card-fields">
      <div class="pf"><label>Description</label><input type="text" placeholder="Enter part description" data-col="0"></div>
      <div class="pf"><label>Part #</label><input type="text" placeholder="Enter part number" data-col="1"></div>
      <div class="pf"><label>Quantity</label><input type="text" inputmode="numeric" placeholder="Enter quantity" data-col="2"></div>
      <div class="pf"><label>Cost</label><input type="text" inputmode="decimal" placeholder="$0.00" data-col="3"></div>
      <div class="pf"><label>Vendor</label><input type="text" placeholder="Enter vendor name" data-col="4"></div>
    </div>`;
  list.appendChild(card);

  const tbody = document.getElementById('partsBody');
  const tr = document.createElement('tr'); tr.dataset.row = n;
  tr.innerHTML = `<td class="row-num">${total}</td><td><input type="text" placeholder="Description" data-col="0"></td><td><input type="text" placeholder="Part #" data-col="1"></td><td><input type="text" placeholder="Qty" data-col="2"></td><td><input type="text" placeholder="$0.00" data-col="3"></td><td><input type="text" placeholder="Vendor" data-col="4"></td><td style="text-align:center"><button class="remove-btn" onclick="removeRow(${n})">&times;</button></td>`;
  tbody.appendChild(tr);

  const ci = card.querySelectorAll('input'), ti = tr.querySelectorAll('input');
  ci.forEach((inp,i) => inp.addEventListener('input', () => { if(ti[i]) ti[i].value=inp.value; saveForm(); }));
  ti.forEach((inp,i) => inp.addEventListener('input', () => { if(ci[i]) ci[i].value=inp.value; saveForm(); }));

  if (!isRestoring) { currentPartIndex = document.querySelectorAll('#partsList .part-card').length - 1; saveForm(); }
  updatePartView();
}

function removeRow(n) {
  document.querySelector(`#partsList .part-card[data-row="${n}"]`)?.remove();
  document.querySelector(`#partsBody tr[data-row="${n}"]`)?.remove();
  renumberRows();
  const total = document.querySelectorAll('#partsList .part-card').length;
  if (total === 0) { addPartRow(); return; }
  if (currentPartIndex >= total) currentPartIndex = total - 1;
  updatePartView(); saveForm();
}

function renumberRows() {
  rowCount = 0;
  document.querySelectorAll('#partsList .part-card').forEach((card,i) => { rowCount=i+1; card.querySelector('.part-card-num').textContent=rowCount; card.querySelector('.part-card-label').textContent='Part '+rowCount; });
  document.querySelectorAll('#partsBody tr').forEach((tr,i) => { tr.querySelector('.row-num').textContent=i+1; });
}

function navigatePart(dir) {
  const total = document.querySelectorAll('#partsList .part-card').length;
  if (!total) return;
  currentPartIndex = Math.max(0, Math.min(total-1, currentPartIndex+dir));
  updatePartView();
}

function updatePartView() {
  const cards = document.querySelectorAll('#partsList .part-card');
  const total = cards.length;
  cards.forEach((c,i) => c.classList.toggle('active', i===currentPartIndex));
  const nav = document.getElementById('partNav');
  nav.style.display = total <= 1 ? 'none' : 'flex';
  const dots = document.getElementById('partDots'); dots.innerHTML = '';
  for (let i=0; i<total; i++) { const d=document.createElement('div'); d.className='part-nav-dot'+(i===currentPartIndex?' active':''); d.onclick=()=>{currentPartIndex=i;updatePartView();}; dots.appendChild(d); }
  document.getElementById('partPrev').disabled = currentPartIndex===0;
  document.getElementById('partNext').disabled = currentPartIndex>=total-1;
  const pc = document.getElementById('partCount');
  if (pc) pc.textContent = total > 0 ? total+' part'+(total!==1?'s':'')+' added' : '';
}

// ── Attach listeners ──
fieldIds.forEach(id => { const el=document.getElementById(id); if(el){el.addEventListener('input',saveForm);el.addEventListener('change',saveForm);} });
radioNames.forEach(name => document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.addEventListener('change', saveForm)));

restoreForm();

function resetForm() {
  if (confirm('Clear all fields? This cannot be undone.')) {
    document.querySelectorAll('.form-body input[type="text"], .form-body textarea').forEach(el => el.value='');
    document.querySelectorAll('.form-body select').forEach(el => el.selectedIndex=0);
    document.querySelectorAll('.form-body input[type="radio"]').forEach(el => el.checked=false);
    document.getElementById('partsList').innerHTML = '';
    document.getElementById('partsBody').innerHTML = '';
    rowCount = 0; currentPartIndex = 0;
    addPartRow();
    localStorage.removeItem(STORAGE_KEY);
  }
}

// ── Dataplate Scanner ──
let capturedImageData = null;

function openCamera() {
  document.getElementById('cameraInput').click();
}

function openGallery() {
  document.getElementById('galleryInput').click();
}

function closeScanner() {
  document.getElementById('scannerModal').classList.remove('active');
  capturedImageData = null;
  document.getElementById('capturedImage').style.display = 'none';
  document.getElementById('scannerStatus').textContent = 'Tap capture to take a photo of the dataplate';
  document.getElementById('scannerStatus').className = 'scanner-status';
  document.getElementById('scannerActions').innerHTML = '<button class="btn-capture" onclick="capturePhoto()">Capture Photo</button>';
}

function capturePhoto() {
  document.getElementById('cameraInput').click();
}

function selectFromGallery() {
  document.getElementById('galleryInput').click();
}

function handleCameraCapture(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    capturedImageData = e.target.result;
    const img = document.getElementById('capturedImage');
    img.src = capturedImageData;
    img.style.display = 'block';

    // Show modal with captured image
    document.getElementById('scannerModal').classList.add('active');
    document.getElementById('scannerStatus').textContent = 'Photo captured. Tap "Extract Data" to scan.';
    document.getElementById('scannerStatus').className = 'scanner-status';
    document.getElementById('scannerActions').innerHTML = `
      <button class="btn-retake" onclick="capturePhoto()">Retake</button>
      <button class="btn-retake" onclick="selectFromGallery()">Gallery</button>
      <button class="btn-use" onclick="processDataplate()">Extract</button>
    `;
  };
  reader.readAsDataURL(file);
  event.target.value = ''; // Reset input
}

async function processDataplate() {
  if (!capturedImageData) return;

  const status = document.getElementById('scannerStatus');
  const actions = document.getElementById('scannerActions');

  status.textContent = 'Processing image... This may take a moment.';
  status.className = 'scanner-status processing';
  actions.innerHTML = '<button class="btn-capture" disabled>Processing...</button>';

  try {
    const result = await Tesseract.recognize(capturedImageData, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          const pct = Math.round(m.progress * 100);
          status.textContent = `Scanning... ${pct}%`;
        }
      }
    });

    const text = result.data.text;
    const extracted = extractDataplateInfo(text);

    if (Object.keys(extracted).length > 0) {
      applyExtractedData(extracted);
      status.textContent = `Found ${Object.keys(extracted).length} field(s). Data applied to form.`;
      status.className = 'scanner-status success';
      actions.innerHTML = `
        <button class="btn-retake" onclick="capturePhoto()">Scan Another</button>
        <button class="btn-use" onclick="closeScanner()">Done</button>
      `;
    } else {
      status.textContent = 'Could not extract data. Try a clearer photo.';
      status.className = 'scanner-status error';
      actions.innerHTML = `
        <button class="btn-retake" onclick="capturePhoto()">Retake Photo</button>
        <button class="btn-use" onclick="closeScanner()">Cancel</button>
      `;
    }
  } catch (err) {
    status.textContent = 'Error processing image. Please try again.';
    status.className = 'scanner-status error';
    actions.innerHTML = `
      <button class="btn-retake" onclick="capturePhoto()">Retake Photo</button>
      <button class="btn-use" onclick="closeScanner()">Cancel</button>
    `;
  }
}

function extractDataplateInfo(text) {
  const data = {};
  const lines = text.toUpperCase().replace(/[|]/g, 'I').replace(/[{}]/g, '');

  // Log for debugging
  console.log('OCR Text:', lines);

  // Known manufacturer names to look for (sorted longest first to avoid partial matches)
  const manufacturers = [
    'AMERICAN STANDARD', 'JOHNSON CONTROLS', 'CLIMATE MASTER', 'HILL PHOENIX',
    'MASTER-BILT', 'DUNHAM-BUSH', 'TURBO AIR', 'ZERO ZONE', 'COMFORTMAKER',
    'MITSUBISHI', 'KELVINATOR', 'HONEYWELL', 'HEATCRAFT', 'TECUMSEH', 'TRAULSEN',
    'ARMSTRONG', 'COPELAND', 'HUSSMANN', 'NOR-LAKE', 'SUB-ZERO', 'TEMPSTAR',
    'KEEPRITE', 'ARCOAIRE', 'FRIEDRICH', 'CARRIER', 'EMBRACO', 'DANFOSS',
    'BRISTOL', 'MAMMOTH', 'RANDELL', 'VICTORY', 'COLEMAN', 'LUXAIRE', 'FUJITSU',
    'SAMSUNG', 'GOODMAN', 'DAIKIN', 'LENNOX', 'KOLPAK', 'MCQUAY', 'NORTEK',
    'REZNOR', 'MODINE', 'EMERSON', 'RUSSELL', 'LARKIN', 'KRAMER', 'TRENTON',
    'MCCALL', 'SPORLAN', 'BEACON', 'MORRIS', 'WALK-IN', 'KYSOR', 'TYLER',
    'TRANE', 'RHEEM', 'BRYANT', 'PAYNE', 'AMANA', 'BOSCH', 'BALLY', 'RUUD',
    'YORK', 'HEIL', 'BARD', 'BOHN', 'AAON', 'TRUE', 'ADP', 'ICP', 'LG'
  ];

  // Check for manufacturer names in text
  for (const mfg of manufacturers) {
    if (lines.includes(mfg)) {
      data.manufacturer = mfg.split(' ').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ');
      console.log('Found manufacturer:', mfg);
      break;
    }
  }

  // Model number patterns
  const modelPatterns = [
    /MODEL\s*[#:.\-]?\s*([A-Z0-9\-\/]+)/i,
    /MOD(?:EL)?\s*[#:.\-]?\s*([A-Z0-9\-\/]+)/i,
    /M\/N\s*[#:.\-]?\s*([A-Z0-9\-\/]+)/i,
    /MN\s*[#:.\-]?\s*([A-Z0-9\-\/]+)/i,
    /MODEL\s+NO\.?\s*([A-Z0-9\-\/]+)/i
  ];
  for (const p of modelPatterns) {
    const m = lines.match(p);
    if (m && m[1] && m[1].length >= 3) { data.model = m[1].trim(); break; }
  }

  // Serial number patterns - labeled first, then common formats
  const serialPatterns = [
    /SERIAL\s*[#:.\-]?\s*([A-Z0-9\-]+)/i,
    /SER(?:IAL)?\s*[#:.\-]?\s*([A-Z0-9\-]+)/i,
    /S\/N\s*[#:.\-]?\s*([A-Z0-9\-]+)/i,
    /SN\s*[#:.\-]?\s*([A-Z0-9\-]+)/i,
    /S\s*N\s*[#:.\-]?\s*([A-Z0-9\-]+)/i,
    /NO\.\s*([A-Z]{1,3}\d{6,})/i,
    /NUMBER\s*[#:.\-]?\s*([A-Z0-9\-]{6,})/i
  ];
  for (const p of serialPatterns) {
    const m = lines.match(p);
    if (m && m[1] && m[1].length >= 4) { data.serial = m[1].trim(); break; }
  }

  // If no labeled serial found, look for typical serial number formats
  if (!data.serial) {
    // Common serial formats: letters followed by numbers (e.g., ABC1234567, W1A1234567)
    // Or year-based serials (e.g., 2019ABC1234, 19W12345)
    const unlabledSerialPatterns = [
      /\b([A-Z]{1,4}\d{6,12})\b/,           // ABC123456 or ABCD12345678
      /\b(\d{4}[A-Z]{1,3}\d{4,8})\b/,       // 2019ABC1234
      /\b([A-Z]\d[A-Z]\d{6,10})\b/,         // W1A1234567 (common Carrier format)
      /\b([A-Z]{2}\d{2}[A-Z]\d{5,8})\b/,    // AB12C12345
      /\b(\d{2}[A-Z]{2}\d{6,8})\b/,         // 19AB123456
      /\b([A-Z]\d{9,12})\b/                 // A123456789
    ];
    for (const p of unlabledSerialPatterns) {
      const matches = lines.match(new RegExp(p.source, 'g'));
      if (matches) {
        // Find the longest match that's not the model number
        for (const match of matches) {
          if (match.length >= 8 && match !== data.model) {
            data.serial = match;
            console.log('Found unlabeled serial:', match);
            break;
          }
        }
        if (data.serial) break;
      }
    }
  }

  // Voltage patterns
  const voltagePatterns = [
    /(\d{2,3}\s*[\/\-]\s*\d{2,3}\s*[\/\-]\s*\d{2,3})\s*V(?:OLT)?/i,
    /(\d{2,3}\s*[\/\-]\s*\d{2,3})\s*V(?:OLT)?/i,
    /VOLT(?:AGE|S)?\s*[#:.\-]?\s*(\d{2,3}(?:\s*[\/\-]\s*\d{2,3})*)/i,
    /(\d{3})\s*V(?:AC|OLT)/i,
    /VOLTS?\s*(\d{2,3})/i
  ];
  for (const p of voltagePatterns) {
    const m = lines.match(p);
    if (m && m[1]) { data.voltage = m[1].replace(/\s/g, '').trim(); break; }
  }

  // Phase patterns
  const phasePatterns = [
    /(\d)\s*(?:PH|PHASE)/i,
    /PHASE\s*[#:.\-]?\s*(\d)/i,
    /PH\s*[#:.\-]?\s*(\d)/i,
    /(\d)\s*Ø/i
  ];
  for (const p of phasePatterns) {
    const m = lines.match(p);
    if (m && m[1]) { data.phase = m[1].trim(); break; }
  }

  // Refrigerant patterns
  const refrigerantPatterns = [
    /(?:REFRIGERANT|REFRIG|REF)[\s:.\-]*([R]?[\-\s]?\d{2,4}[A-Z]?)/i,
    /\b(R[\-\s]?410\s*[A]?)\b/i,
    /\b(R[\-\s]?22)\b/i,
    /\b(R[\-\s]?134\s*[A]?)\b/i,
    /\b(R[\-\s]?404\s*[A]?)\b/i,
    /\b(R[\-\s]?407\s*[A-C]?)\b/i,
    /\b(R[\-\s]?32)\b/i,
    /\b(R[\-\s]?290)\b/i,
    /\b(R[\-\s]?600\s*[A]?)\b/i,
    /\b(R[\-\s]?454\s*[A-B]?)\b/i,
    /\b(R[\-\s]?1234[A-Z]{2})\b/i,
    /\b(R[\-\s]?438\s*[A]?)\b/i,
    /\b(R[\-\s]?448\s*[A]?)\b/i,
    /\b(R[\-\s]?449\s*[A]?)\b/i,
    /\b(R[\-\s]?452\s*[A-B]?)\b/i,
    /\b(410\s*[A])\b/i,
    /\b(404\s*[A])\b/i,
    /CHARGE[^\n]*(R[\-\s]?\d{2,4}[A-Z]?)/i
  ];
  for (const p of refrigerantPatterns) {
    const m = lines.match(p);
    if (m && m[1]) {
      let ref = m[1].replace(/[\s\-]/g, '').toUpperCase().trim();
      // Ensure it starts with R
      if (!ref.startsWith('R') && /^\d/.test(ref)) ref = 'R' + ref;
      // Format nicely like R-410A
      ref = ref.replace(/^R(\d)/, 'R-$1');
      data.refrigerant = ref;
      console.log('Found refrigerant:', ref);
      break;
    }
  }

  console.log('Extracted data:', data);
  return data;
}

function applyExtractedData(data) {
  if (data.manufacturer) {
    document.getElementById('manufacturer').value = data.manufacturer;
  }
  if (data.model) {
    document.getElementById('modelNumber').value = data.model;
  }
  if (data.serial) {
    document.getElementById('serialNumber').value = data.serial;
  }
  if (data.voltage) {
    document.getElementById('voltage').value = data.voltage;
  }
  if (data.phase) {
    document.getElementById('phase').value = data.phase;
  }
  if (data.refrigerant) {
    document.getElementById('refrigerant').value = data.refrigerant;
  }
  saveForm();
}
</script>
</body>
</html>
